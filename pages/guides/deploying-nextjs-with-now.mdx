import Guide from '~/components/layout/guide'
import { TerminalInput } from '~/components/text/terminal'
import { Code, InlineCode } from '~/components/text/code'
import Caption from '~/components/text/caption'
import Note from '~/components/text/note'
import { GenericLink } from '~/components/text/link'
import Card from '~/components/card'
import { P } from '~/components/text/paragraph'

export const meta = {
  title: 'Getting Started with Next.js and Now',
  description: 'Creating a Next.js project and deploying it with ZEIT Now',
  published: '2019-06-03T12:00:00.860Z',
  authors: ['timothy', 'msweeneydev'],
  url: '/guides/deploying-nextjs-with-now',
  image:
    'https://og-image.now.sh/**Deploy%20Serverless%20Next.js**%20with%20Now.png?theme=light&md=1&fontSize=83px&images=https%3A%2F%2Fassets.zeit.co%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnow-black.svg&images=https%3A%2F%2Fassets.zeit.co%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg&heights=250&heights=350',
  editUrl: 'pages/guides/deploying-nextjs-with-now.mdx',
  lastEdited: '2019-06-04T16:12:53.000Z'
}

This guide will help you get started using [Next.js](https://nextjs.org/) with [Now](/now) by covering a variety of topics from [Installing Now](#installing-now) to deploying your Next.js application **with a single command**.

Next.js is a framework, created by [ZEIT](https://zeit.co), for creating production-ready, fast, and extended React applications with a lot of handy features built-in.

## Installing Now

To get started with Now, you need to install it first. For your convenience, we have provided three options for installing it below.

<Note>
  If you already have Now installed, you can{' '}
  <GenericLink href="#creating-the-project">skip this section</GenericLink>.
</Note>

#### Now Desktop

[Now Desktop](/download) provides Now through a desktop user interface, providing a visual experience along with the following benefits:

- Creating deployments with **drag and drop**
- Keeps **Now CLI up-to-date** at all times
- View your **team's event feed**

To install Now Desktop, visit the [download page](/download) and select the platform relevant to you.

#### Yarn or npm

For those who prefer to use the command line, we also provide the option to install the Now through either [Yarn](https://yarnpkg.com/) or [npm](https://www.npmjs.com/).

To install Now with Yarn:

<TerminalInput>yarn global add now</TerminalInput>
<Caption>Installing Now globally with Yarn.</Caption>

To install Now with npm:

<TerminalInput>npm install -g now</TerminalInput>
<Caption>Installing Now globally with npm.</Caption>

#### Curl

If you would prefer to install without using a package manager, then the option to install Now via [Curl](https://curl.haxx.se/) is available.

To install Now with Curl:

<TerminalInput>curl -sfLS https://zeit.co/download.sh | sh</TerminalInput>
<Caption>Installing Now with Curl.</Caption>

#### GitHub and GitLab Integrations

To enhance your development experience with Now further, we also provide integrations with both [GitHub](/docs/v2/integrations/now-for-github/) and [GitLab](/docs/v2/integrations/now-for-gitlab/).

The Now for GitHub and GitLab integrations have many features to improve your workflow:

- Deploys every push in branches and pull requests to preview changes live
- Aliases the most recent changes from the master branch
- Instant rollbacks when reverting changes that have been aliased

You can read more about the [GitHub](/docs/v2/integrations/now-for-github/) and [GitLab](/docs/v2/integrations/now-for-gitlab/) integrations, including how to install them, in the [documentation](/docs/).

## Creating the Project

The application you make will feature a static frontend, created with [Next.js](https://nextjs.org/), and also feature a [Node.js](https://nodejs.org/) backend, showing how simple it is to deploy monorepo's with Now.

The first thing you should do is create a project directory and `cd` into it:

<TerminalInput>mkdir my-nextjs-project && cd my-nextjs-project</TerminalInput>
<Caption>Creating an entering into the <InlineCode>my-nextjs-project</InlineCode> project directory.</Caption>

With the project directory created, initialize the project like so:

<TerminalInput>yarn init -y</TerminalInput>
<Caption>Initializing your project with a <InlineCode>package.json</InlineCode> file.</Caption>

The last step before creating your Next.js frontend is to add the project dependencies:

<TerminalInput>yarn add moment next react react-dom</TerminalInput>
<Caption>Adding <InlineCode>moment</InlineCode>, <InlineCode>next</InlineCode>, <InlineCode>react</InlineCode> and <InlineCode>react-dom</InlineCode> as dependencies to your project.</Caption>

#### Creating the Next.js Frontend

With your project setup, create a `/pages` folder for your Next.js frontend:

<TerminalInput>mkdir pages</TerminalInput>
<Caption>Creating a <InlineCode>/pages</InlineCode> folder in your project for your Next.js frontend.</Caption>

Inside your `/pages` folder, create an `index.js` file with the following content:

```jsx
import { useEffect, useState } from 'react'
import Head from 'next/head'

export default function HomePage() {
  const [data, setData] = useState({})
  useEffect(() => {
    async function getData() {
      const res = await fetch('/api/code/7')
      const { code, greeting } = await res.json()
      setData({ code, greeting })
    }
    getData()
  }, [])
  return (
    <>
      <Head>
        <title>Next.js + Node.js API</title>
        <link rel="stylesheet" href="../static/index.css" type="text/css" />
      </Head>
      <h1>Next.js + Node.js API</h1>
      <h2>
        Developed & Deployed with{' '}
        <a
          href="https://zeit.co/docs"
          target="_blank"
          rel="noreferrer noopener"
        >
          ZEIT Now
        </a>
        !
      </h2>
      <br />
      <p>{(data && data.greeting) || 'Loading date...'}</p>
      <p>You provided the code: {(data && data.code) || '???'}</p>
    </>
  )
}
```

<Caption>
  An <InlineCode>index.js</InlineCode> file for your Next.js frontend.
</Caption>

The `index.js` file displays static content whilst loading data from an API in the background that you will soon create.

By rendering the static markup on page load rather than waiting for the API data, your site will always appear **lightning fast**.

#### Creating the Node.js API

With your Next.js frontend setup, create an `/api` folder for your Node.js API endpoints:

<TerminalInput>mkdir api</TerminalInput>
<Caption>Creating an <InlineCode>/api</InlineCode> folder in your project for your Node.js API endpoints.</Caption>

Inside your `/api` folder, create a `date.js` file with the following content:

```js
const moment = require('moment')
const url = require('url')

module.exports = (req, res) => {
  const { query } = url.parse(req.url, true)
  const { code } = query
  const currentTime = moment().format('MMMM Do YYYY, h:mm:ss a')
  const name = process.env.NAME
  const greeting = `The date and time at ${name}'s current location is: ${currentTime}`

  res.end(JSON.stringify({ code, greeting }))
}
```

<Caption>
  A <InlineCode>date.js</InlineCode> file for your Node.js API.
</Caption>

The `date.js` file uses `moment` to obtain and format the current date and time before sending it as a response to the frontend.

#### Creating the Static CSS File

With both frontend and backend taken care of, create a `/static` folder for your CSS:

<TerminalInput>mkdir static</TerminalInput>
<Caption>Creating a <InlineCode>/static</InlineCode> folder in your project for your static CSS files.</Caption>

Inside your `/static` folder, create an `index.css` file with the following content:

```css
body {
  font-family: 'SF Pro Text', 'SF Pro Icons', 'Helvetica Neue', 'Helvetica',
    'Arial', sans-serif;
  padding: 20px 20px 60px;
  max-width: 680px;
  margin: 0 auto;
  font-size: 16px;
  line-height: 1.65;
  text-align: center;
}

h1 {
  margin-top: 70px;
  font-size: 45px;
}

a {
  cursor: pointer;
  color: #0076ff;
  text-decoration: none;
  transition: all 0.2s ease;
  border-bottom: 1px solid white;
}

a:hover {
  border-bottom: 1px solid #0076ff;
}

p {
  font-size: 16px;
}
```

<Caption>
  An <InlineCode>index.css</InlineCode> file to style your project.
</Caption>

## Adding `now.json` and `.nowignore`

To provide configuration for your project, you should use a `now.json` file.

The `now.json` file allows you to do many things such as [setting up an alias](/docs/v2/deployments/configuration/#alias), [adding builders to build your files](/docs/v2/deployments/configuration/#builds) and [rewriting requesting URLS](/docs/v2/deployments/configuration/#routes).

These slightly more advanced topics will be looked at in the [next section]. For now, create a `now.json` file at the root of your project with the following code:

```json
{
  "version": 2,
  "alias": "my-aliased-nodejs-project",
  "name": "my-nodejs-project"
}
```

<Caption>
  An initial <InlineCode>now.json</InlineCode> file to configure your project.
</Caption>

With this configuration you have setup the project `version`, `alias` and `name`, let's find out what they do:

#### Version

The `version` property is used to specify which [Now platform version](/docs/v2/deployments/configuration/#version) to use for the deployment.

<Note>
  Only version 2 is available for accounts created after January 03 2019.
</Note>

#### Alias

The `alias` property is used to alias deployments to another domain when using either the [Now for GitHub](/docs/v2/integrations/now-for-github/) or [Now for GitLab](/docs/v2/integrations/now-for-gitlab/) integrations.

When pushing to a branch, each push will be [aliased](/docs/v2/domains-and-aliases/aliasing-a-deployment/) to the domain(s) specified.

#### Name

The `name` property is used to provide a [prefix](/docs/v2/deployments/configuration#name) to your deployments.

#### `.nowignore`

The `.nowignore` file works similar to a `.gitignore` file and is used to tell the Now CLI, [Now for GitHub](/docs/v2/integrations/now-for-github/) and [Now for GitLab](/docs/v2/integrations/now-for-github/) integrations to not upload certain files or directories.

<Note>
  The <InlineCode>.nowignore</InlineCode> file is populated by default with{' '}
  <GenericLink href="LINK TO ISSUE 767 DOCS">
    various files and directories
  </GenericLink>
  .
</Note>

Create a `.nowignore` file in the root of your project directory with the following code:

```bash
yarn.lock
```

Now that you've provided some **simple configuration** for your Next.js project, let's see in the next section **how easy it is to build your files**.

## Adding Builders

[Builders](docs/v2/deployments/builders/overview/) provide the step that turns your source code into [production ready outputs](/docs/v2/deployments/builds/#sources-and-outputs).

These outputs can be either static files and/or [lambdas](/docs/v2/deployments/concepts/lambdas/), **both get served** by our [CDN at the Edge](/docs/v2/domains-and-aliases/cdn/) to make your deployments blazing fast to access around the globe.

<Note>
  You should use Builders whenever your source files require a transformation to
  be served to users.
</Note>

For this project, you will require the use of three different Builders, [`@now/next`](/docs/v2/deployments/official-builders/next-js-now-next/), [`@now/node`](/docs/v2/deployments/official-builders/node-js-now-node/) and [`@now/static`](/docs/v2/deployments/official-builders/static-now-static/).

**Using Builders is simple**, to do so, add the following code to your `now.json` file:

```json
{
  ...
  "builds": [
    { "src": "api/**/*.js", "use": "@now/node" },
    { "src": "next.config.js", "use": "@now/next" },
    { "src": "static/**/*", "use": "@now/static" }
  ]
}
```

<Caption>
  Adding Builds to your projects' <InlineCode>now.json</InlineCode> file.
</Caption>

As you can see, **targeting certain directories and file types is straightforward**, providing you with **granular control** over which files get built and how you build them.

## Adding Routes

Like Builders, Routes are defined in the `now.json` file and provide a powerful option for routing requests.

As you will see shortly, Routes are objects that consist of `src` and `dest` properties. The `src` is used to match the incoming request, and the `dest` determines how that request is routed.

Your project requires a single route so that your Next.js frontend can reach your API, to do this, add the following to your `now.json` file:

```json
{
  ...
  "routes": [
    { "src": "/api/code/(?<code>[^/]*)", "dest": "api/date?code=$code" }
  ],
}
```

<Caption>
  Adding a Route to your projects' <InlineCode>now.json</InlineCode> file.
</Caption>

The above Route provides an example of how powerful Routes are. A request is made to `/api/code/<code>`, this is matched and rewritten to `api/date/7`.

As you can see, passing query parameters is easy to do when rewriting Routes. Taking advantage of this feature allows you to keep your routes clean whilst passing data to your API without having to use the request body.

Rewriting Routes is just one of many features available, you can read about them more in the [Routes documentation](/docs/v2/deployments/routes/).

<Note>
  Routes are read from top to bottom with requests being routed on the first
  match.
</Note>

## Environment Variables and Secrets

In this section you will discover how to work with environment variables and secrets in both [development](/docs/v2/development/environment-variables/) and [production](/docs/v2/deployments/environment-variables-and-secrets/).

#### Local Development

During **local development** with `now dev`, which you will read more about in the next section, environment variables should be set using a `.env` file.

Create a `.env` file at the root of your project directory with the following code, adding your name where indicated:

```bash
NAME=your-name
```

<Caption>
  Adding a NAME environment variable to your projects'{' '}
  <InlineCode>.env</InlineCode> file.
</Caption>

<Note>
  To discourage using development secrets for production,{' '}
  <InlineCode>.env</InlineCode> files <P.B>are not uploaded</P.B> by the Now CLI
  during deployment.
</Note>

#### Cloud Deployment

To ensure your project is ready for production, you should also add your environment variable as a [secret](/docs/v2/deployments/environment-variables-and-secrets/#securing-environment-variables-using-secrets).

Once you store a secret, its contents are **no longer accessible directly** by anyone, providing a secure way to store any sensitive information.

Add your secret to your project with the following command:

<TerminalInput>now secrets add NAME your-name</TerminalInput>
<Caption>Adding a <InlineCode>secret</InlineCode> to your account to use within your project.</Caption>

#### Updating `now.json`

With your environment variable added to both development and production environments, update your `now.json` file to make it available inside your project.

Add the [`.env` key]() to your `now.json` file with the following content:

```json
{
  ...
  "env": {
    "NAME": "@name"
  }
}
```

<Caption>
  Adding a NAME environment variable to your projects'{' '}
  <InlineCode>now.json</InlineCode> file to make it available for use.
</Caption>

In the above example, the `NAME` key is used to provide a reference inside your project to the `name` environment variable or secret.

<Note>
  Secrets are added at the account level, allowing for reuse in multiple
  projects.
</Note>

Your project is now complete and ready for further development, this is looked at further in the next section.

## Local Development with `now dev`

For a **seamless local development experience**, you should use `now dev`, a reproduction of the Now deployment environment but on your local machine.

Using `now dev` allows you to develop and debug your application in as close to a production environment as possible. With `now dev` you build quickly, with **real trust and confidence**.

As hinted at above, you can start developing locally with **just a single command**:

<TerminalInput>now dev</TerminalInput>
<Caption>Starting a local development server with the  <InlineCode>now dev</InlineCode> command.</Caption>

After shortly installing and setting up the required builders, `now dev` will start on port 3000 if available, else the next available port.

<Note>
  When using <InlineCode>now dev</InlineCode>, you must declare your environment
  variables in a <InlineCode>.env</InlineCode> file.
</Note>

`now dev` watches your files for any changes, automatically updating when any are made, leaving you free to focus on developing your application.

## Cloud Deployment with `now`

When you're happy with your project and ready to share it with the world, it is time to **deploy with Now**.

Just like `now dev`, cloud deployment is handled with **just a single command**:

<TerminalInput>now</TerminalInput>
<Caption>Deploying your project with the <InlineCode>now</InlineCode> command.</Caption>

After your project has been built and deployed, you will **receive a deployment URL** with the following format:

<Code>my-nextjs-project.account-name.now.sh</Code>
<Caption>An example deployment URL for your project.</Caption>

Your project is live at this URL immediately, allowing it to be shared with whoever you like.

## Further Examples

You can see more examples of [Next.js](https://nextjs.org/) on [Now](/now) at the Now Examples [GitHub repository](https://github.com/zeit/now-examples).

Below is a list of all Next.js examples available:

- [Next.js](https://github.com/zeit/now-examples/tree/master/nextjs)
- [Next.js Static](https://github.com/zeit/now-examples/tree/master/nextjs-static)
- [Next.js News](https://github.com/zeit/now-examples/tree/master/nextjs-news)
- [Next.js + MySQL](https://github.com/zeit/now-examples/tree/master/nextjs-mysql)

These examples show how Next.js can be used with Now in a variety of different situations.

You can **get your project started in seconds** by building on top of any of these examples with the help of `now init`:

<TerminalInput>now init</TerminalInput>
<Caption>Using the <InlineCode>now init</InlineCode> command to create a project from an example.</Caption>

After entering the `now init` command, you will be presented with the list of projects to choose from the Now Examples [GitHub repository](https://github.com/zeit/now-examples).

All of these examples are immediately ready for either [local development](/guides/deploying-nextjs-with-now#local-development-with-now-dev) or [cloud deployment](/guides/deploying-nextjs-with-now#cloud-deployment-with-now) to help you get your project up and running **as quick as possible**.

## Frequently Asked Questions

export default ({ children }) => <Guide meta={meta}>{children}</Guide>
